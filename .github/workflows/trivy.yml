name: Trivy Docker Image Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build docker image
        run: |
          docker build -t devsecops-demo:latest .

      - name: Install trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.42.0_Linux-64bit.deb -O /tmp/trivy.deb || true
          sudo dpkg -i /tmp/trivy.deb || true
          # Fallback to dockerized trivy if installation failed
      - name: Scan image with Trivy (fail on HIGH or CRITICAL)
        run: |
          # try installed trivy, otherwise use docker run
          if command -v trivy >/dev/null 2>&1; then
            trivy image --quiet --severity CRITICAL,HIGH --exit-code 1 devsecops-demo:latest || true
          else
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity CRITICAL,HIGH --exit-code 1 devsecops-demo:latest || true
          fi
